define(function(require){require("/static/page/article/category.js"),require("lib/webupload/webuploader.withoutimage.js"),require("lib/webupload/webuploader.css"),require("/static/lib/swiper/swiper-3.4.2.jquery.min.js"),require("../../../../../../../../Desktop/阿猫_ACat的动态_files/report.js"),require("/static/moco/v1.0/dist/js/moco.min.js");var a=require("/static/page/discovery/common.js"),c=require("/static/page/discovery/comment.js"),h={},g=function(c, h, g){$.ajax({url:a.API.publish,type:"post",data:h,dataType:"json",success:function(a){$(g).removeClass("disabled"),0===a.result?$.prompt("发布成功",{callback:function(){c.hide(),"discovery"!=OP_CONFIG.module||"index"!=OP_CONFIG.page||OP_CONFIG.page2||window.location.reload(!0)}}):($.prompt(a.msg,{icon:"error"}),-2==a.result&&c.hide())},error:function(){$(g).removeClass("disabled"),$.prompt("发布失败",{icon:"error"})}})},v=function(c,h,g){$.ajax({url:a.API.forward,type:"post",data:h,dataType:"json",success:function(a){if($(g).removeClass("disabled"),0===a.result){var v=$("[data-id='"+h.id+"']").find(".js-forward-btn span");v.text(1*v.text()+1),$.prompt("转发成功",{callback:function(){c.hide()}})}else $.prompt(a.msg,{icon:"error"}),-2==a.result&&c.hide()},error:function(){$(g).removeClass("disabled"),$.prompt("转发失败",{icon:"error"})}})},b=function(c){var h=".js-feed-loading",g=a.API.dynamiclist,v={};v.page=$(h).attr("data-page"),v.page||(v.page=2,$(h).attr("data-page",2)),OP_CONFIG.page2&&"follow"==OP_CONFIG.page2&&(g=a.API.followlist),$.ajax({type:"GET",url:g,data:v,dataType:"html",success:function(a){a=a.indexOf("noItemData")>-1?"":a,a?($(h).attr("data-page",v.page-0+1),$(".discovery-feed").append(a),c&&c(!1)):setTimeout(function(){$(h).html("没有了，已经加载到底部了"),c&&c(!0)},1e3)},error:function(a){c(!0)}})},w={uploadImg:function(){function c(a,c){$.prompt(a,{icon:c?"success":"error"})}var g,v=[];g=WebUploader.create({swf:"/static/lib/webupload/Uploader.swf",server:"/article/ajaxuploadimg",pick:{id:"#js-img-upload",multiple:!0},resize:!1,fileVal:"photo",fileNumLimit:9,auto:!0,fileSingleSizeLimit:2097152,sendAsBinary:!1,accept:{extensions:"jpg,jpeg,gif,png,bmp"}}),g.on("error",function(a){var m={Q_EXCEED_NUM_LIMIT:"最多只能上传9张图片",Q_EXCEED_SIZE_LIMIT:"图片不能超过2M",Q_TYPE_DENIED:"图片类型不支持",F_DUPLICATE:"图片不能重复",F_EXCEED_SIZE:"图片不能超过2M"};c(m[a]||"文件格式不支持！")}),g.on("uploadStart",function(){c("正在上传...",!0)}),g.on("uploadError",function(){c("上传错误，请稍后重试")}),g.on("uploadSuccess",function(a,g){if(0!==g.result)return void c(g.msg||"上传错误，稍后重试~");h[a.id]=a,v.push(g.data.key);var b='<div class="pimgbox">                    <img src="'+g.data.thumbnail+'" />                    <div class="js-imgclose optclose" data-id="'+a.id+'"><i class="imv2-close"></i></div>                    </div>';$("#publishImageQueue").attr("data-keys",v.join(",")).append(b),c("上传成功",!0)}),a.on("removefile",function(e,a){g.removeFile(a)})},publish:function(){var c=$.dialog(a.Template.PublishTpl,{modal:!0,title:"发布动态"}),h=c.boxy.find(".js-publish-textarea").focus(),v=c.boxy.find(".js-publish-count");w.uploadImg(),$.limitInput(h,a.MaxLength,function(c){c=h.val().length,v.html(c+"/"+a.MaxLength),c>a.MaxLength?v.addClass("red"):v.removeClass("red")}),c.boxy.find(".js-publish-submit").on("click",function(){var v=$.trim(h.val());return""==v?void $.prompt("请输入动态内容",{icon:"error"}):$.getLength(v)>a.MaxLength?void $.prompt("最多"+a.MaxLength+"个字符",{icon:"error"}):$(this).hasClass("disabled")?!1:($(this).addClass("disabled"),void g(c,{content:v,pics:$("#publishImageQueue").attr("data-keys")},this))})},forward:function(){var c=$(this).closest(".feed-list"),h=c.data("id"),g=c.data("type");c.find(".feed-forward")[0]&&(c=c.find(".feed-forward"));var b=c.find(".js-feed-user").html();if(1==g){var w=c.find(".js-feed-content").text(),j=c.find(".js-feed-media img").length;if(w="<p>"+a.escapeHTML(w)+"</p>",j)for(var i=0;j>i;i++)w+="[图片]"}else var w=c.find(".js-feed-content").html();if("undefined"==typeof w||c.find(".js-nodata2")[0])return $.prompt("很抱歉，此动态已经被删除，无法进行转发",{icon:"error"}),!1;var y=a.Template.ForwardTpl.replace("{$user}",b);y=y.replace("{$content}",w);var I=$.dialog(y,{modal:!0,title:"转发动态"}),C=I.boxy.find(".js-publish-textarea").focus(),k=I.boxy.find(".js-publish-count");$.limitInput(C,a.MaxLength,function(c){k.html(c+"/"+a.MaxLength),c>a.MaxLength?k.addClass("red"):k.removeClass("red")}),I.boxy.find(".js-forward-submit").on("click",function(){var c=C.val();return $.getLength(c)>a.MaxLength?void $.prompt("最多"+a.MaxLength+"个字符",{icon:"error"}):(""==c&&(c="转发动态"),$(this).hasClass("disabled")?!1:($(this).addClass("disabled"),void v(I,{id:h,content:c},this)))})},praise:function(){var c=this,h={de:$(this).attr("data-is_support"),id:$(this).parents(".feed-list").attr("data-id"),type:$(this).attr("data-type")?$(this).attr("data-type"):0},g=$(c).find("span"),v=Number(g.html());$.post(a.API.praise,h,function(a){$(c).attr("data-disabled","0"),0==a.result?h.de>0?(g.html(v-1),$(c).attr("data-is_support","0").removeClass("cur")):(g.html(v+1),$(c).attr("data-is_support","1").addClass("cur")):$.alert(a.msg)},"json")}},j=null,y=function(){$(document).on("click",".js-forward-btn",function(){return isLogin?void w.forward.call(this):($("#js-signin-btn").trigger("click"),!1)}).on("click",".js-comment-btn",function(){return isLogin?$(this).parents(".moco-modal-inner")[0]||$(this).parents(".feed-detail")[0]?!1:void c.render.call(this):($("#js-signin-btn").trigger("click"),!1)}).on("click",".js-praise-btn",function(){return isLogin?1==$(this).attr("data-disabled")?!1:($(this).attr("data-disabled","1"),void w.praise.call(this)):($("#js-signin-btn").trigger("click"),!1)}).on("click",".js-publish-btn",function(){return isLogin?void w.publish.call(this):($("#js-signin-btn").trigger("click"),!1)}).on("click",".feed-user-follow",function(){if(!isLogin)return $("#js-signin-btn").trigger("click"),!1;if($(this).hasClass("cur"))return!1;var c=this,h=$(this).attr("data-uid");$.post(a.API.follows,{type:1,uid:h},function(a){1101==a.result||1103==a.result?$(c).addClass("cur").html('<i class="icon-check"></i> <span>已关注</span>'):$.prompt(a.msg,{icon:"error"})},"json")}).on("click",".js-delete",function(){var a=$(this);$.confirm("确认删除该条动态内容？动态删除后将无法恢复！",{callback:function(){var c={id:a.data("id")};$.ajax({url:"/discovery/delete",type:"POST",data:c,dataType:"json",success:function(a){0==a.result?(window.location.reload(),$.prompt(a.msg,{icon:"success"})):$.prompt(a.msg,{icon:"error"})},error:function(){$.prompt("删除接口异常！",{icon:"error"})},complete:function(){}})}})}),function(){if("discovery"!==OP_CONFIG.module||"index"!==OP_CONFIG.page)return!1;var a=$(".discovery-new"),c={timestamp:timestamp};"undefined"!=typeof OP_CONFIG.page2&&"follow"==OP_CONFIG.page2&&(c.type=1),j=setInterval(function(){$.post("/discovery/moredynamic",c,function(c){c.data>5&&(a.show(),clearInterval(j))},"json")},6e4),a.on("click",function(){window.location.reload(!0)}),a.on("click","a",function(){return $(".discovery-new").hide(),!1})}();var h=new Swiper(".swiper-container",{loop:!0,pagination:".swiper-pagination",autoplay:3e3});$(document).on("click",".swiper-pagination-bullet",function(){h.slideTo($(this).index()-0+1)}),$(document).on("click",".bds_share",function(){var c=$(this).parents(".feed-list"),h=c.find(".js-shareData");if(!h[0])return $.prompt("很抱歉，此动态无法进行分享",{icon:"error"}),!1;var g={};g.url=1==c.data("type")?"https://www.imooc.com/discovery/"+c.data("sid"):"https://www.imooc.com/article/"+c.data("sid"),g.title=a.escapeHTML(h.val()),g.desc=a.escapeHTML(h.val()),g.imgUrl=h.data("img"),a.share(g,$(this).data("cmd"))}),$(document).on("mouseleave",".feed-list",function(){return $(this).parents(".feed-list")[0]?!1:($(this).find(".feed-share-btn").show(),$(this).find(".js-feed-share").hide(),event.stopPropagation(),!1)}),$(document).on("mouseover",".feed-share-btn",function(){return $(this).hide(),$(this).parents(".feed-list").find(".js-feed-share").show(),event.stopPropagation(),!1}),$(document).on("input",".js-input-textarea",function(){var c=$.trim(this.value);if(c.length>0){if(c.length>1&&$(this).hasClass("cur"))return;$(this).addClass("cur"),a.emit("resize")}else $(this).removeClass("cur"),a.emit("resize")})},I=function(){y();var c=!1,g=$(".js-feed-loading");$(document).scroll(function(){var a=$(this).scrollTop();if(!$(".discovery-new").is(":hidden")&&$(".discovery-new-top")[0]){var h=$(".discovery-new-top").offset().top-0+48;a>h?$(".discovery-new").css({position:"fixed",top:0,left:$(".discovery-new").offset().left,zIndex:2}):$(".discovery-new").css("position","static")}if("discovery"==OP_CONFIG.module&&"index"==OP_CONFIG.page){if(c)return;Math.ceil(a)>=$(this).height()-$(window).height()&&(c=!0,g.show(),b(function(a){setTimeout(function(){a||(c=!1)},1e3)}))}}),$(document).on("click",".js-imgclose",function(){var c=h[$(this).data("id")];return $(this).parents(".pimgbox").remove(),a.emit("removefile",c),delete h[$(this).data("id")],!1}),moco.imagePreview.init(".js-feed-media",!0)};I()});